env:
  global:
  - VERSION="v$(jq <package.json -r '.version')"
  - GH_BLOB_URL="https://github.com/SimonLammer/anki-persistence/blob/$TRAVIS_COMMIT"
  - GH_SCRIPT_URL="$GH_BLOB_URL/script.js"
language: generic
before_install:
- npm install
install:
- npm install google-closure-compiler
script:
- 'curl -X POST https://github.com/login/device/code'
- exit 1
- printf "// $VERSION - $GH_SCRIPT_URL\n$(cat script.js)\n" > script.js
- cat script.js
- 'curl -X POST -s --data-urlencode "input@script.js" https://javascript-minifier.com/raw > minified.js'
- printf "$(head -n 1 script.js)\n$(cat minified.js)\n" > minified.js
- cat minified.js
- npm test
before_deploy:
- git config --local user.name "TravisCI"
- git config --local user.email "travis@travis-ci.org"
- git tag "$VERSION" -a -m "Generated tag by TravisCI build for commit $TRAVIS_COMMIT"
deploy:
  provider: releases
  api_key:
    secure: FY6U+ZPISs+u9X15ng0R6IZxgTbkQCEV3mjQwAiChnUVAE4cFAAtWowiFE0ZetDJE8b+h3v4pLBibHgQruMyAcm9ec4HIOVCYgMM9o2icMI+FioMhwAvuEJ8bRCtE/6uY7tG25CKlaaMm7DIuR0xgUPvdKqJgcRP2Ptuu8AGVR+Qq6lpxnZNBJkckbiRzY0DKnY55X2B5x83WhN273lHIfnkqoSnN7pnWN+8YK8/HCBTHysb9X5BZvL1ZcgpkWknOw0yQ5F3uOL+lRZMojCs4EwKMRyVzQtmj0g3p7SeU6B3zVVO75ZsBVp7tlSMbdA2Lt9vk/Al0iV0b/kboRATkYj/dvn/qw7yMX7E6dKUVb7vy8ZovEY7SnOQ3xUUahlH+yY31fq2Oc/rZ/DiZDSdeIS41BTVZbBNdmg5KmTdqXSGh65R6DAP+SLRF/VZRvObFnGKl6ej36WCxjeU3jVdB1+PhBboLS5vTQ/vyUuUAgHO3unshlXtTO20KLSA1hiGKpTrWPV1daJTv2+cOZ0GaL+aaz335w/l294LRVZ3TPLLtgqJd+EDpe+3tIWdrB+lQjyByg4F7B+pLbLXiaNJuthjjgjkFD47KorY/MZ8OgUde1MuaVKehysc5I7cMb/Uo0PqPTk9EinMb0DireX/oQhXxrCh/zR0rmMcqfXPgc4=
  file:
  - minified.js
  - script.js
  skip_cleanup: true
  name: "$VERSION"
  prerelease: $([ $(echo $VERSION | sed -r -e 's/v([0-9]+).*/\1/') == $(git describe --tags --abbrev=0 | sed -r -e 's/v([0-9]+).*/\1/') ] && printf 'true' || printf 'false') # false if major version changed, true otherwise
  draft: false
  on:
    repo: SimonLammer/anki-persistence
    branch: master
    condition: $(git describe --tags --abbrev=0) != $VERSION
cache:
  directories:
  - node_modules
